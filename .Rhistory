require(tidyverse)
#load TcmN HMM data and recode sampleType for the complexity of the synthetic sample (#of genomes in samples)
cyclase_TcmN <- read_delim("combined-cyclase_TcmN-full-synthetic_genomes-results.txt",col_names = F, delim = "\t")
names(cyclase_TcmN) <- c("readID", "sampleType", "sampleID", "cyclaseType", "HMMScore")
# Function to aggregate identitical sample reads located at different reading frames
# and take the frame with the highest HMM score
formatHMM<-function(hmmdf){
hmmdfRecoded <- separate(hmmdf, readID, into = c("readIDOnly","F_R_read_frame"), sep = "/", extra = "merge")
hmmdfRecoded_FR <- separate(hmmdfRecoded, F_R_read_frame, into = c("F_R","frameNumb"), sep = "_", extra = "merge")
hmmdfRecodedDF<- within(hmmdfRecoded_FR, readID <- paste(readIDOnly,F_R, sep='/'))
hmmdfRecodedDFUnique<-aggregate(HMMScore ~ readID + sampleID + sampleType + cyclaseType , hmmdfRecodedDF, max)
colnames(hmmdfRecodedDFUnique)<-c("readID","Sample", "sampleType", "cyclaseType","HMMScore")
return(hmmdfRecodedDFUnique)
}
#Keep duplicated reads if they are in different reads
cyclaseTcmN_recoded<-formatHMM(cyclase_TcmN)
#BLAST True positive reads mapped to the T2PKS cyclases genes
cyclase_metadata <- read_tsv("../T2PKS-pos_genomes-cyclase_gene-metadata.txt", col_names = T) %>% filter(used_in_synthetic_metagenome == "Y") %>% select(c(11:9))
# BLAST filtered data
t2pksBlastDF <- read_delim("../../T2PKS-TP-reads/t2pksBlastDF_filter-results.txt", col_names = T, delim = "\t") %>% inner_join(.,cyclase_metadata, by= c("qseqid" = "nucl_cyclase_target_name") )%>% filter(cyclase_type == "TcmN")
compareCyclaseReads<-function(cyclaseDF, blastDF){
names(blastDF)[names(blastDF)=="sseqid"] <-"readID"
names(blastDF)[names(blastDF)=="qseqid"] <-"bgcName"
names(cyclaseDF)[names(cyclaseDF)=="cyclaseType"] <-"cyclase_type"
common_reads <- blastDF %>% inner_join(.,cyclaseDF) %>% select(-c(HMMScore))
common_reads$readCheck<-"common-read"
hmm_unique_reads <- cyclaseDF %>% anti_join(.,blastDF)
hmm_unique_reads$readCheck<-"hmm-unique-read"
blast_unique_reads <- blastDF %>% anti_join(.,cyclaseDF)
blast_unique_reads$readCheck<-"blast-unique-read"
blast_common_data <- rbind(common_reads, blast_unique_reads)
allCyclases_TP<- blast_common_data %>% full_join(.,hmm_unique_reads)
allCyclases_TP$bgcName[is.na(allCyclases_TP$bgcName)]<-"hmm-unique-read"
return(allCyclases_TP %>% select(-c(HMMScore)))
}
##############################################################################################
cyclaseTcmN_bin <- compareCyclaseReads(cyclaseTcmN_recoded,t2pksBlastDF)
names(cyclaseTcmN_bin)[names(cyclaseTcmN_bin)=="cyclase_type"] <-"cyclaseType"
compare_reads <- function(hmm_df, blast_df){
names(blast_df)[names(blast_df)=="sseqid"] <-"readID"
names(blast_df)[names(blast_df)=="qseqid"] <-"bgcName"
names(hmm_df)[names(hmm_df)=="cyclaseType"] <-"cyclase_type"
common_reads <- hmm_df %>% semi_join(.,blast_df)
common_reads$readCheck<-"common-read"
hmm_unique_reads <- hmm_df %>% anti_join(.,blast_df)
hmm_unique_reads$readCheck<-"hmm-unique-read"
compared_data <- rbind(common_reads, hmm_unique_reads)
return(compared_data)
}
compare_reads(cyclaseTcmN_recoded, t2pksBlastDF) %>% filter(readCheck == "common-read") %>% mutate(medianScore = round(median(HMMScore))) %>% distinct(readCheck, medianScore) %>% ungroup()
#Filter TcmN data with cutoffs to compare to BLAST interval reads
TcmN_filtered_median <- cyclaseTcmN_recoded %>% filter(HMMScore >=25) %>% inner_join(.,cyclaseTcmN_bin)
#TcmN_filtered_median  %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)
pks_genomes_median_check <-c("JOFH01000019.1", "gi|640932211|gb|JJOH01000028.1|", "gi|640930959|gb|JJOH01000095.1|")
remaining_hmm_TcmN_pos_median_check <- TcmN_filtered_median %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% filter(scaffold_id %in% pks_genomes_median_check)
####################################################################################
TcmN_filtered_median_subfive<- cyclaseTcmN_recoded %>% filter(HMMScore >=20) %>% inner_join(.,cyclaseTcmN_bin)
#TcmN_filtered_median_subfive  %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)
pks_genomes_subfive_check <-c("gi|928414697|gb|LGKI01000478.1|", "gi|529222834|ref|NC_021985.1|", "JOFH01000019.1", "AZXI01000002.1", "gi|1098134558|emb|FOXX01000014.1|", "gi|640932211|gb|JJOH01000028.1|", "gi|640930959|gb|JJOH01000095.1|")
remaining_hmm_TcmN_pos_subfive_check <- TcmN_filtered_median_subfive %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% filter(scaffold_id %in% pks_genomes_subfive_check)
####################################################################################
TcmN_filtered_median_plusfive <- cyclaseTcmN_recoded %>% filter(HMMScore>=30) %>% inner_join(.,cyclaseTcmN_bin)
#TcmN_filtered_median_plusfive  %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)
#No hmm-unique read swith HMM Score of 30
#Function to parse out HMM unique reads for each sample.
parseReads <- function(HMMdf, modelName, dirname){
setwd(dirname)
samples<-unique(HMMdf$Sample)
for (s in 1:length(samples)){
currentSample<-samples[s]
currentSampleResults<- HMMdf %>% filter(Sample == currentSample)
currentSampleReads<- unique(currentSampleResults$readID)
fileName<-paste0(currentSample,paste("-",modelName,"-hmm_unique",sep =""), ".txt", sep ="")
write.table(currentSampleReads,fileName, quote = F, row.names = F, col.names = F )
}
}
#parseReads(remaining_hmm_TcmN_pos_median_check, "cyclaseTcmN", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/HMM-analysis/TcmN/full_model-analysis/hmm-unique-analysis/median_score/")
#parseReads(remaining_hmm_TcmN_pos_subfive_check, "cyclaseTcmN", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/HMM-analysis/TcmN/full_model-analysis/hmm-unique-analysis/minus_five_score")
calculate_F1 <- function(df){
TP <- df %>% filter(readCheck == "common-read") %>% nrow()
FP <- df %>% filter(readCheck == "hmm-unique-read") %>% nrow()
FN <- df %>% filter(readCheck == "blast-unique-read") %>% nrow()
F1_metric <- (2*TP)/((2*TP)+FP+FN)
print(F1_metric)
return(F1_metric)
}
TcmN_f1_cutoff_median <- calculate_F1(compareCyclaseReads(cyclaseTcmN_recoded %>% filter(HMMScore >=25),t2pksBlastDF)) #0.2344109
#TcmN_f1_cutoff_plusfive <-calculate_F1(compareCyclaseReads(cyclaseTcmN_recoded %>% filter(HMMScore >=30),t2pksBlastDF)) #0.3028763
TcmN_f1_cutoff_subfive <- calculate_F1(compareCyclaseReads(cyclaseTcmN_recoded %>% filter(HMMScore >=20),t2pksBlastDF)) #0.4582721
sessionInfo()
cyclaseTcmN_recoded %>% filter(HMMScore >=30) %>% anti_join(.,t2pksBlastDF)
cyclaseTcmN_recoded %>% filter(HMMScore >=30) %>% inner_join(.,t2pksBlastDF, by=c("readID"= "sseqid", "Sample", "sampleType"))
cyclaseTcmN_recoded %>% filter(HMMScore >=30) %>% inner_join(.,t2pksBlastDF, by=c("readID"= "sseqid", "Sample", "sampleType")) %>% dim()
cyclaseTcmN_recoded %>% filter(HMMScore >=30) %>% inner_join(.,t2pksBlastDF, by=c("readID"= "sseqid", "Sample", "sampleType")) %>% group_by(readID, Sample) %>% distinct() %>% nrow()
cyclaseTcmN_recoded %>% filter(HMMScore >=30) %>% anti_join(.,t2pksBlastDF, by=c("readID"= "sseqid", "Sample", "sampleType")) %>% group_by(readID, Sample) %>% distinct() %>% nrow()
t2pksBlastDF  %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30), by=c("sseqid"= "readID", "Sample", "sampleType")) %>% group_by(readID, Sample) %>% distinct() %>% nrow()
t2pksBlastDF  %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30), by=c("sseqid"="readID", "Sample", "sampleType")) %>% group_by(readID, Sample) %>% distinct() %>% nrow()
t2pksBlastDF  %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30), by=c("sseqid", "Sample", "sampleType")) %>% group_by(readID, Sample) %>% distinct() %>% nrow()
head(t2pksBlastDF)
t2pksBlastDF %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30), by=c("sseqid", "Sample", "sampleType")) %>% group_by(readID, Sample) %>% distinct() %>% nrow()
t2pksBlastDF %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30), by=c("sseqid"= "readID", "Sample", "sampleType")) %>% group_by(readID, Sample) %>% distinct() %>% nrow()
t2pksBlastDF %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30))
t2pksBlastDF %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30), by=c("sseqid"= "readID", "Sample", "sampleType"))
t2pksBlastDF %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30), by=c("sseqid"= "readID", "Sample", "sampleType"))%>% group_by(readID, Sample) %>% distinct() %>% nrow()
t2pksBlastDF %>% anti_join(.,cyclaseTcmN_recoded %>% filter(HMMScore >=30), by=c("sseqid"= "readID", "Sample", "sampleType"))%>% group_by(sseqid, Sample) %>% distinct() %>% nrow()
2*534
1068+10983
1068/12051
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/HMM-analysis/TcmN/')
# load neccessary packages
require(tidyverse)
require(ggsci)
require(ggpubr)
#load TcmN HMM data and recode sampleType for the complexity of the synthetic sample (#of genomes in samples)
cyclase_TcmN <- read_delim("combined-cyclase_TcmN-spHMM-synthetic_genomes-results.txt",col_names = F, delim = "\t") %>% filter( X7 %in% c("150_180", "160_190","170_200", "180_210","190_220", "200_230", "210_240", "220_250", "230_260",
"240_270", "250_280", "250_280", "260_290", "270_300", "280_310", "290_320", "300_330", "310_340"))
names(cyclase_TcmN) <- c("readID", "sampleType", "sampleID", "cyclaseType", "HMMScore", "window","interval")
cyclase_TcmN$sampleType[str_detect(cyclase_TcmN$sampleID, "high") ==TRUE] <-"high"
cyclase_TcmN$sampleType[str_detect(cyclase_TcmN$sampleID, "low") ==TRUE] <-"low"
cyclase_TcmN$interval <- factor(cyclase_TcmN$interval,levels = c("150_180", "160_190",
"170_200", "180_210","190_220", "200_230", "210_240", "220_250", "230_260",
"240_270", "250_280", "260_290", "270_300", "280_310", "290_320", "300_330", "310_340"))
# Function to aggregate identitical sample reads located at different reading frames
# and take the frame with the highest HMM score
formatHMM<-function(hmmdf){
hmmdfRecoded <- separate(hmmdf, readID, into = c("readIDOnly","F_R_read_frame"), sep = "/", extra = "merge")
hmmdfRecoded_FR <- separate(hmmdfRecoded, F_R_read_frame, into = c("F_R","frameNumb"), sep = "_", extra = "merge")
hmmdfRecodedDF<- within(hmmdfRecoded_FR, readID <- paste(readIDOnly,F_R, sep='/'))
hmmdfRecodedDFUnique<-aggregate(HMMScore ~ readID + sampleID + sampleType + cyclaseType + window + interval, hmmdfRecodedDF, max)
colnames(hmmdfRecodedDFUnique)<-c("readID","Sample", "sampleType", "cyclaseType", "window", "interval","HMMScore")
return(hmmdfRecodedDFUnique)
}
#Keep duplicated reads if they are in different reads
cyclaseTcmN_recoded<-formatHMM(cyclase_TcmN)
#BLAST True positive reads mapped to the T2PKS cyclases genes
cyclase_metadata <- read_tsv("../T2PKS-pos_genomes-cyclase_gene-metadata.txt", col_names = T) %>% filter(used_in_synthetic_metagenome == "Y") %>% select(c(11:9))
# BLAST unfiltered reads at 95% pident no readCoverage filter
all_t2pksBlastDF <- read_delim("../../T2PKS-TP-reads/t2pksBlastDF_all-results.txt", col_names = T, delim = "\t") %>% inner_join(.,cyclase_metadata, by= c("qseqid" = "nucl_cyclase_target_name") )
#load cyclases interval positions data
tcmn_positions <- read_tsv("../../T2PKS-TP-reads/cyclases_genes-interval_position-data.txt",col_names = T) %>% filter(cyclase_type == "TcmN")
filter_blast <- function(df, pos_df){
results <- data.frame()
for (i in 1:nrow(pos_df)){
gene_data <- pos_df[i,]
#filters datatframe for edges and internal reads compared to model interval
interval_df_1 <- df %>% filter(qseqid ==gene_data$gene_name) %>%
filter(qstart %in% gene_data$start:gene_data$end | qend %in% gene_data$start:gene_data$end)
# need to get reads that are bigger than the interval
interval_df_2 <- df %>% filter(qseqid ==gene_data$gene_name) %>%
filter(qstart < gene_data$start & qend > gene_data$end)
interval_df <- rbind(interval_df_1,interval_df_2)
if (nrow(interval_df) > 0){
for (j in 1:nrow(interval_df)){
in_interval_count <- sum(interval_df[j,]$qstart:interval_df[j,]$qend %in% gene_data$start:gene_data$end)
interval_count <- length(gene_data$start:gene_data$end)
interval_cov <- (in_interval_count/interval_count) * 100
if (interval_cov >=90){
res_df<-interval_df[j,]
res_df$model_cov <- interval_cov
res_df$interval <- gene_data$interval
results <- rbind(results,res_df)
}
}
}
}
return(results)
}
#Filter BLAST reads that are within the TcmN genes intervals and cover 90% of the model interval
tcmN_blast_intervals<- filter_blast(all_t2pksBlastDF %>% filter(cyclase_type == "TcmN"), tcmn_positions)
compare_reads <- function(hmm_df, blast_df){
names(blast_df)[names(blast_df)=="sseqid"] <-"readID"
names(blast_df)[names(blast_df)=="qseqid"] <-"bgcName"
names(hmm_df)[names(hmm_df)=="cyclaseType"] <-"cyclase_type"
# remove columns to compare the two dataframe
blastDF <- blast_df %>% select(-c(model_cov, interval))
common_reads <- hmm_df %>% semi_join(.,blastDF)
common_reads$readCheck<-"common-read"
hmm_unique_reads <- hmm_df %>% anti_join(.,blastDF)
hmm_unique_reads$readCheck<-"hmm-unique-read"
compared_data <- rbind(common_reads, hmm_unique_reads)
return(compared_data)
}
cyclaseTcmN_bin <- compare_reads(cyclaseTcmN_recoded, tcmN_blast_intervals)
names(cyclaseTcmN_bin)[names(cyclaseTcmN_bin)=="cyclase_type"] <-"cyclaseType"
cyclaseTcmN_bin %>% filter(readCheck == "common-read") %>% group_by(interval) %>% mutate(medianScore = round(median(HMMScore))) %>% distinct(interval, readCheck, medianScore) %>% ungroup()
#Function to find the hmm_unique reads that are also mapped using BLAST but didn't make 90% interval
compare_hmm_unique <- function(hmm_df, blast_df, pos_df){
#hmm_unique_df <- hmm_df  %>% inner_join(.,blast_df, by = c("readID"="sseqid", "Sample", "sampleType","cyclaseType"= "cyclase_type"))
hmm_unique_df <- hmm_df  %>% inner_join(.,blast_df, by = c("readID"="sseqid", "Sample", "sampleType", "cyclase_type"))
intervals <- unique(hmm_unique_df$interval)
results <- data.frame()
#check that reads are in the same interval to throw out
for (i in 1:length(intervals)){
gene_interval_data <- pos_df %>% filter(interval == intervals[i])
for (k in 1:nrow(gene_interval_data)){
gene_data <- gene_interval_data[k,]
#filters datatframe for edges and internal reads compared to model interval
interval_df  <- hmm_unique_df %>% filter(qseqid ==gene_data$gene_name) %>%
filter(qstart %in% gene_data$start:gene_data$end | qend %in% gene_data$start:gene_data$end)
if (nrow(interval_df) > 0 ){
results <- rbind(results,interval_df)
}
}
}
return(results%>% distinct())
}
#Filter TcmN data with cutoffs to compare to BLAST interval reads
TcmN_filtered_median <- cyclaseTcmN_recoded %>% filter((interval == "150_180" & HMMScore >=30 )|
(interval == "160_190" & HMMScore >=30 )|
(interval == "170_200" & HMMScore >=30 )|
(interval == "180_210" & HMMScore >=25 )|
(interval == "190_220" & HMMScore >=20 )|
(interval == "200_230" & HMMScore >=20 )|
(interval == "210_240" & HMMScore >=30 )|
(interval == "220_250" & HMMScore >=30 )|
(interval == "230_260" & HMMScore >=30 )|
(interval == "240_270" & HMMScore >=30 )|
(interval == "250_280" & HMMScore >=30 )|
(interval == "260_290" & HMMScore >=30 )|
(interval == "270_300" & HMMScore >=25 )|
(interval == "280_310" & HMMScore >=25 )|
(interval == "290_320" & HMMScore >=25 )|
(interval == "300_330" & HMMScore >=25 )|
(interval == "310_340" & HMMScore >=25 ))
TcmN_filtered_median_subfive <- cyclaseTcmN_recoded %>% filter((interval == "150_180" & HMMScore >=25 )|
(interval == "160_190" & HMMScore >=25 )|
(interval == "170_200" & HMMScore >=25 )|
(interval == "180_210" & HMMScore >=20 )|
(interval == "190_220" & HMMScore >=15 )|
(interval == "200_230" & HMMScore >=15 )|
(interval == "210_240" & HMMScore >=25 )|
(interval == "220_250" & HMMScore >=25 )|
(interval == "230_260" & HMMScore >=25 )|
(interval == "240_270" & HMMScore >=25 )|
(interval == "250_280" & HMMScore >=25 )|
(interval == "260_290" & HMMScore >=25 )|
(interval == "270_300" & HMMScore >=20 )|
(interval == "280_310" & HMMScore >=20 )|
(interval == "290_320" & HMMScore >=20 )|
(interval == "300_330" & HMMScore >=20 )|
(interval == "310_340" & HMMScore >=20 ))
TcmN_filtered_median_plusfive <- cyclaseTcmN_recoded %>% filter((interval == "150_180" & HMMScore >=35 )|
(interval == "160_190" & HMMScore >=35 )|
(interval == "170_200" & HMMScore >=35 )|
(interval == "180_210" & HMMScore >=30 )|
(interval == "190_220" & HMMScore >=25 )|
(interval == "200_230" & HMMScore >=25 )|
(interval == "210_240" & HMMScore >=35 )|
(interval == "220_250" & HMMScore >=35 )|
(interval == "230_260" & HMMScore >=35 )|
(interval == "240_270" & HMMScore >=35 )|
(interval == "250_280" & HMMScore >=35 )|
(interval == "260_290" & HMMScore >=35 )|
(interval == "270_300" & HMMScore >=30 )|
(interval == "280_310" & HMMScore >=30 )|
(interval == "290_320" & HMMScore >=30 )|
(interval == "300_330" & HMMScore >=30 )|
(interval == "310_340" & HMMScore >=30 ))
#return the hmm-unique reads
return_hmm_unique <- function(hmm_df, blast_df){
oxyn_hmm_df <- hmm_df  %>% select(-c(window))
oxyn_hmm_df$interval <- as.character(oxyn_hmm_df$interval)
names(oxyn_hmm_df)[names(oxyn_hmm_df)=="cyclaseType"] <-"cyclase_type"
names(blast_df)[names(blast_df)=="sseqid"] <-"readID"
OxyN_hmm_unique <- oxyn_hmm_df %>% anti_join(.,blast_df, by= c("readID", "Sample", "sampleType", "interval"))
return(OxyN_hmm_unique)
}
median_tcmN_hmmunique <-return_hmm_unique(TcmN_filtered_median, tcmN_blast_intervals)
median_TcmN_hmmunique_less_model_cov<-compare_hmm_unique(median_tcmN_hmmunique,all_t2pksBlastDF,tcmn_positions )
median_remaining_hmm_tcmn<- median_tcmN_hmmunique %>% anti_join(.,median_TcmN_hmmunique_less_model_cov)
table(median_remaining_hmm_tcmn$interval)
pks_genomes_median_check <- c("gi|529222834|ref|NC_021985.1|", "gi|640937269|gb|JJOH01000002.1|", "JOFH01000011.1", "gi|1081600317|emb|FMWJ01000012.1|", "AZXI01000002.1")
#median_remaining_hmm_tcmn %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)
remaining_hmm_tcmn_pos_median_check <- median_remaining_hmm_tcmn %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% filter(scaffold_id %in% pks_genomes_median_check)
############################################################################################################################
subfive_tcmN_hmmunique <-return_hmm_unique(TcmN_filtered_median_subfive, tcmN_blast_intervals)
subfive_TcmN_hmmunique_less_model_cov<-compare_hmm_unique(subfive_tcmN_hmmunique,all_t2pksBlastDF,tcmn_positions )
subfive_remaining_hmm_tcmn<- subfive_tcmN_hmmunique %>% anti_join(.,subfive_TcmN_hmmunique_less_model_cov)
table(subfive_remaining_hmm_tcmn$interval)
#subfive_remaining_hmm_tcmn %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)
pks_genomes_subfive_check <- c(" gi|529222834|ref|NC_021985.1|", "JOFH01000019.1", "gi|640937269|gb|JJOH01000002.1|", "JOFH01000011.1", "gi|1081600317|emb|FMWJ01000012.1|", "AZXI01000002.1", "gi|1081601449|emb|FMWJ01000005.1|")
remaining_hmm_tcmn_pos_subfive_check <- subfive_remaining_hmm_tcmn %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% filter(scaffold_id %in% pks_genomes_subfive_check)
############################################################################################################################
plusfive_tcmN_hmmunique <-return_hmm_unique(TcmN_filtered_median_plusfive, tcmN_blast_intervals)
plusfive_TcmN_hmmunique_less_model_cov<-compare_hmm_unique(plusfive_tcmN_hmmunique,all_t2pksBlastDF,tcmn_positions )
plusfive_remaining_hmm_tcmn<- plusfive_tcmN_hmmunique %>% anti_join(.,plusfive_TcmN_hmmunique_less_model_cov)
table(plusfive_remaining_hmm_tcmn$interval)
#plusfive_remaining_hmm_tcmn %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)
pks_genomes_plusfive_check <- c("gi|640937269|gb|JJOH01000002.1|", "gi|529222834|ref|NC_021985.1|")
remaining_hmm_tcmn_pos_plusfive_check <- plusfive_remaining_hmm_tcmn %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% filter(scaffold_id %in% pks_genomes_plusfive_check)
#Function to parse out HMM unique reads for each sample.
parseReads <- function(HMMdf, modelName, dirname){
setwd(dirname)
samples<-unique(HMMdf$Sample)
for (s in 1:length(samples)){
currentSample<-samples[s]
currentSampleResults<- HMMdf %>% filter(Sample == currentSample)
currentSampleReads<- unique(currentSampleResults$readID)
fileName<-paste0(currentSample,paste("-",modelName,"-hmm_unique",sep =""), ".txt", sep ="")
write.table(currentSampleReads,fileName, quote = F, row.names = F, col.names = F )
}
}
#parseReads(remaining_hmm_tcmn_pos_median_check, "cyclaseTcmN", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/HMM-analysis/TcmN/hmm-unique-analysis/median_score/")
#parseReads(remaining_hmm_tcmn_pos_subfive_check, "cyclaseTcmN", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/HMM-analysis/TcmN/hmm-unique-analysis/minus_five_score/")
#parseReads(remaining_hmm_tcmn_pos_plusfive_check, "cyclaseTcmN", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/HMM-analysis/TcmN/hmm-unique-analysis/plus_five_score/")
blast_hmm_unique <- read_tsv("/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/HMM-analysis/TcmN/hmm-unique-analysis/TcmN_hmm-unique_blast-results.txt", col_names = T)
filter_hmm_unique  <- function(df, pos_df){
results <- data.frame()
for (i in 1:nrow(df)){
blast_data <- df[i,]
domain <- blast_data$sseqid
domain_interval <- blast_data$interval
gene_data <- pos_df %>% filter( gene_name == domain  & interval == domain_interval)
#filters datatframe for edges and internal reads compared to model interval
interval_df_1 <- blast_data %>% filter(sseqid ==gene_data$gene_name) %>%
filter(sstart %in% gene_data$start:gene_data$end | send %in% gene_data$start:gene_data$end)
# need to get reads that are bigger than the interval
interval_df_2 <- df %>% filter(sseqid ==gene_data$gene_name) %>%
filter(sstart < gene_data$start & send > gene_data$end)
interval_df <- rbind(interval_df_1,interval_df_2)
}
return(interval_df)
}
median_blast_df <- blast_hmm_unique %>% filter(cutoff== "median_score") %>% inner_join(., remaining_hmm_tcmn_pos_median_check, by = c("qseqid" = "readID", "Sample"))
subfive_blast_df <- blast_hmm_unique %>% filter(cutoff== "minus_five_score") %>% inner_join(., remaining_hmm_tcmn_pos_subfive_check, by = c("qseqid" = "readID", "Sample"))
plusfive_blast_df <- blast_hmm_unique %>% filter(cutoff== "plus_five_score") %>% inner_join(., remaining_hmm_tcmn_pos_plusfive_check, by = c("qseqid" = "readID", "Sample"))
filter_hmm_unique(median_blast_df,tcmn_positions) %>% as.data.frame()
filter_hmm_unique(subfive_blast_df,tcmn_positions) %>% as.data.frame()
filter_hmm_unique(plusfive_blast_df,tcmn_positions) %>% as.data.frame()
calculate_F1 <- function(hmm_df, hmm_fp, blast_df, intervals){
#added this because factor vector
hmm_df$interval <- as.character(hmm_df$interval)
hmm_df <- hmm_df %>% select(-c(window))
names(hmm_df)[names(hmm_df)=="cyclaseType"] <-"cyclase_type"
names(blast_df)[names(blast_df)=="sseqid"] <-"readID"
results<-data.frame(interval=character(), F1=numeric())
for (i in 1:length(intervals)){
model <- intervals[i]
model_hmm <- hmm_df %>% filter(interval== model) # filter out model HMM results
model_blast <- blast_df %>% filter(interval== model)
model_hmm_fp <-hmm_fp %>% filter(interval== model)
TP <- model_hmm %>% inner_join(.,model_blast) %>% nrow()
FP <- model_hmm_fp %>% nrow()
FN <- model_blast %>% anti_join(.,model_hmm) %>% nrow()
F1_metric <- (2*TP)/((2*TP)+FP+FN)
row <- data.frame(cbind(model, F1_metric))
results<- results %>% add_row(interval = model, F1 = F1_metric)
}
return(results)
}
remove_tcmN_reads_subfive  <- c("JOFH01000019.1-21136/2")
remove_tcmN_reads_median  <- c("gi|529222834|ref|NC_021985.1|-10672/2")
subfive_false_postives <- subfive_remaining_hmm_tcmn %>% filter(!readID %in% remove_tcmN_reads_subfive)
median_false_postives <- median_remaining_hmm_tcmn %>% filter(!readID %in% remove_tcmN_reads_median)
tcmn_f1_cutoff_median <- calculate_F1(TcmN_filtered_median, median_false_postives, tcmN_blast_intervals,
unique(cyclaseTcmN_recoded$interval))
tcmn_f1_cutoff_median$cutoff<- "median"
tcmn_f1_cutoff_plusfive<- calculate_F1(TcmN_filtered_median_plusfive, plusfive_remaining_hmm_tcmn, tcmN_blast_intervals, unique(cyclaseTcmN_recoded$interval))
tcmn_f1_cutoff_plusfive$cutoff<- "+5"
tcmn_f1_cutoff_subfive<- calculate_F1(TcmN_filtered_median_subfive, subfive_false_postives, tcmN_blast_intervals, unique(cyclaseTcmN_recoded$interval))
tcmn_f1_cutoff_subfive$cutoff<- "-5"
tcmn_f1_df <- rbind(tcmn_f1_cutoff_median,tcmn_f1_cutoff_plusfive,tcmn_f1_cutoff_subfive )
supp_fig_tcmN_f1 <-ggplot(data = tcmn_f1_df, mapping = aes(x = interval, y = F1, group= cutoff, colour=cutoff )) + geom_point()+
geom_line() + ylim(0,1)+ geom_hline(yintercept=.50, linetype="dashed",
color = "red", size=1) + theme_pubclean() +  scale_color_npg(name="HMM Score Cutoff")
#ggsave(supp_fig_tcmN_f1, file="TcmN_synthetic_F1-supp.eps", device="eps", width = 17, height = 7)
final_ggplot_tcmN<- tcmn_f1_df %>% group_by(interval) %>% top_n(1, F1) %>% ungroup() %>% ggplot(., mapping = aes(x = interval, y = F1, group= 1 )) + geom_point()+  ylim(0,1)+
geom_line() +  geom_hline(yintercept=.50, linetype="dashed",
color = "red", size=1) + theme_pubclean()+ scale_color_npg()
#ggsave(final_ggplot_tcmN, file="TcmN_synthetic_F1-final.eps", device="eps", width = 17, height = 7)
# Finalized cutoffs with intervals and cutoffs
TcmN_filtered_final <- cyclaseTcmN_recoded %>% filter((interval == "150_180" & HMMScore>=25)|
(interval == "160_190" & HMMScore>=25)|
(interval == "170_200" & HMMScore >=25 ) |
(interval == "180_210" & HMMScore >=20 )|
(interval == "210_240" & HMMScore >=25 )|
(interval == "220_250" & HMMScore >=25 )|
(interval == "230_260" & HMMScore >=25 )|
(interval == "240_270" & HMMScore >=25 )|
(interval == "250_280" & HMMScore >=30 )|
(interval == "260_290" & HMMScore >=25 ))
#TcmN_filtered_final%>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)
#rename TcmN hmm_unique within the folder to detected_reads
#parseReads(TcmN_filtered_final, "cyclaseTcmN", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/read-quantification/TcmN/sample-readIDs-files")
final_ggplot_tcmn_full<- tcmn_f1_df %>% group_by(interval) %>% top_n(1, F1) %>% ungroup() %>% ggplot(., mapping = aes(x = interval, y = F1, group= 1 )) + geom_point()+ ylim(0,1)+
geom_line() +  geom_hline(yintercept=.50, linetype="dashed",
color = "red", size=1) + geom_hline(yintercept=0.4582721, linetype="dashed",
color = "green", size=1) +theme_pubclean()
#ggsave(final_ggplot_tcmn_full, file="TcmN_synthetic_F1-final-with-Full-F1.eps", device="eps", width = 17, height = 7)
sessionInfo()
final_ggplot_tcmn_full
ggsave(final_ggplot_tcmn_full, file="TcmN_synthetic_F1-final-with-Full-F1.eps", device="eps", width = 17, height = 7)
require(tidyverse)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data.csv", col_names = T)
head(df)
devtools::install_github("ironholds/geohash")
bird_data <- df %>% select(-c(nest_id))
head(bird_data)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
head(df)
bird_data <- df %>% select(-c(nest_id, latitude, longitude))
head(bird_data)
bird_data%>% group_by(geohash, day, hour) %>% count()
bird_data%>% group_by(geohash, day, hour) %>% count() %>% tail()
bird_data%>% group_by(geohash, day, hour, minute) %>% count()
bird_data%>% group_by(geohash, day, hour, minute) %>% count() %>% arrange(desc(n))
bird_data%>% group_by(geohash,bird_id) %>% count() %>% arrange(desc(n))
bird_data %>% filter(bird_id == "4322c6d9-1314-40da-a5eb-194e1a04bbad")
bird_data %>% filter(bird_id == "4322c6d9-1314-40da-a5eb-194e1a04bbad") %>% count(geohash)
bird_data %>% filter(bird_id == "4322c6d9-1314-40da-a5eb-194e1a04bbad") %>% count(day)
bird_data %>% filter(bird_id == "4322c6d9-1314-40da-a5eb-194e1a04bbad") %>% count(hour)
bird_data %>% filter(bird_id == "4322c6d9-1314-40da-a5eb-194e1a04bbad") %>% count(day, hour)
bird_data %>% filter(bird_id == "4322c6d9-1314-40da-a5eb-194e1a04bbad") %>% count(day, hour) %>% as.data.frame()
bird_data%>% group_by(geohash,bird_id) %>% count() %>% arrange(desc(n))
bird_data%>% group_by(geohash,bird_id) %>% count() %>% arrange(desc(n)) %>% ungroup() %>% count(geohash)
bird_data%>% group_by(geohash,bird_id) %>% count() %>% arrange(desc(n)) %>% ungroup() %>% count(geohash) %>% arrange(desc(n))
bird_data%>% group_by(geohash,bird_id) %>% count() %>% arrange(desc(n)) %>% ungroup() %>% count(geohash) %>% arrange(desc(nn))
bird_data %>% filter(geohash == "9q59x95m")
bird_data %>% filter(geohash == "9q59x95m") %>% count(bird_id)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
head(df)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
head(df)
head(df)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23)
head(nightly_pick_up)
head(nightly_pick_up)
nightly_pick_up %>% group(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% count()
nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% count()
nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% count() %>% arrange(desc(n))
nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
scooter_counts <- nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
head(scooter_counts)
scooter_counts %>% filter(low_battery == 1 )%>% arrange(desc(n))
setwd("/Users/francinecamacho/Documents/Insight/Project/bird-view")
write_csv("bird_data_counts.csv", col_names = T)
write_csv(scooter_counts, "bird_data_counts.csv", col_names = T)
head(scooter_counts)
nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% head()
nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% distinct(bird_id) %>% nrow()
nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% ungroup() %>% distinct(bird_id) %>% nrow()
require(tidyverse)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23) # filter by 9PM -11:55PM data
head(nightly_pick_up)
require(tidyverse)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23) # filter by 9PM -11:55PM data
scooter_counts <- nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
head(scooter_counts)
scooter_counts$n[scooter_counts$low_battery == 0] <-0 #
head(scooter_counts)
scooter_counts <- nightly_pick_up %>% group_by(geohash, day_of_week, weekend, low_battery, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
scooter_counts$n[scooter_counts$low_battery == 0] <- integer(0) #
scooter_counts$n[scooter_counts$low_battery == 0] <- 0 #
write_csv(scooter_counts, "bird_data_pickups.csv", col_names = T)
head(scooter_counts)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23)  %>% filter(low_battery != 0)# filter by 9PM -11:55PM data
scooter_counts <- nightly_pick_up %>% group_by(geohash, day_of_week, weekend, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
write_csv(scooter_counts, "bird_data_pickups.csv", col_names = T)
nightly_pick_up %>% filter(geohash == "9q59x95c")
nightly_pick_up %>% filter(geohash == "9q59x95c") %>% distinct(bird_id)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23)  %>% filter(low_battery != 0)# filter by 9PM -11:55PM data
scooter_counts <- nightly_pick_up %>% group_by(geohash, day_of_week, weekend, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
dim(scooter_counts)
head(scooter_counts)
unique(scooter_counts$geohash)
unique(scooter_counts$geohash) %>% length()
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23)  %>% filter(low_battery != 0)# filter by 9PM -11:55PM data
scooter_counts <- nightly_pick_up %>% group_by(geohash, day_of_week, weekend, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
unique(scooter_counts$geohash) %>% length()
head(scooter_counts)
scooter_counts %>% group_by(geohash, day_of_week)
scooter_counts %>% group_by(geohash, day_of_week) %>% mutate(max = max(n))
scooter_counts %>% group_by(geohash, day_of_week) %>% mutate(max = max(n)) %>% ungroup() %>% select(c(geohash,day_of_week, max ))
scooter_counts %>% group_by(geohash, day_of_week) %>% mutate(max = max(n)) %>% ungroup() %>% select(c(geohash,day_of_week, max )) %>% distinct()
scooter_counts %>% group_by(geohash, day_of_week) %>% mutate(max = max(n)) %>% ungroup() %>% select(c(geohash,day_of_week, max )) %>% distinct() %>% ggplot(aes(x = day_of_week, y = max)) + facet_wrap(~geohash)
require(tidyverse)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23)  %>% filter(low_battery != 0)# filter by 9PM -11:55PM data
scooter_counts <- nightly_pick_up %>% group_by(geohash, day_of_week, weekend, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
#write_csv(scooter_counts, "bird_data_pickups.csv", col_names = T)
scooter_counts %>% group_by(geohash, day_of_week) %>% mutate(max = max(n)) %>% ungroup() %>% select(c(geohash,day_of_week, max )) %>% distinct() %>% ggplot(aes(x = day_of_week, y = max)) + facet_wrap(~geohash)
scooter_counts %>% group_by(geohash, day_of_week) %>% mutate(max = max(n)) %>% ungroup() %>% select(c(geohash,day_of_week, max )) %>% distinct() %>% ggplot(aes(x = day_of_week, y = max)) + geom_bar(stat = "identity") + facet_wrap(~geohash)
df %>% distinct(hour)
df %>% distinct(hour,minute)
df %>% distinct(hour,minute) %>% head(n=50)
df %>% distinct(hour,minute) %>% as.data.frame() %>% head(n=30)
df %>% distinct(hour,minute) %>% as.data.frame() %>% head(n=100)
head(nightly_pick_up)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data_pickups.csv", col_names = T)
head(df)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
head(df)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data_pickups.csv", col_names = T)
head(df)
require(tidyverse)
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data_pickups.csv", col_names = T)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23)  %>% filter(low_battery != 0)# filter by 9PM -11:55PM data
df <- read_csv("~/Documents/Insight/Project/bird-view/bird_data-reformated.csv", col_names = T)
nightly_pick_up <- df  %>% filter(hour >= 21 & hour <= 23)  %>% filter(low_battery != 0)# filter by 9PM -11:55PM data
scooter_counts <- nightly_pick_up %>% group_by(geohash, day_of_week, weekend, day, hour, minute) %>% count() %>% arrange(desc(n)) %>% ungroup()
head(nightly_pick_up)
unique(nightly_pick_up$bird_id) %>% length()
nightly_pick_up %>% unite(.,"timestamp", "month/day/ hour:minute")
nightly_pick_up %>% unite(.,"month/day/ hour:minute", "timestamp",)
nightly_pick_up %>% unite(.,"month/day/ hour:minute", "timestamp")
nightly_pick_up %>% unite(.,"time", "hour:minute")
nightly_pick_up %>% unite(.,"time", "hour_minute")
